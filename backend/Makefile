.PHONY: help build build-dev build-prod run-dev run-prod test clean validate-config

# é»˜è®¤ç›®æ ‡
help:
	@echo "AutoCodeWeb Backend æ„å»ºå·¥å…·"
	@echo "=========================="
	@echo "å¯ç”¨å‘½ä»¤:"
	@echo "  build-dev     - æ„å»ºå¼€å‘ç¯å¢ƒé•œåƒ"
	@echo "  build-prod    - æ„å»ºç”Ÿäº§ç¯å¢ƒé•œåƒ"
	@echo "  run-dev       - å¯åŠ¨å¼€å‘ç¯å¢ƒ"
	@echo "  run-prod      - å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ"
	@echo "  test          - è¿è¡Œæµ‹è¯•"
	@echo "  clean         - æ¸…ç†æ„å»ºæ–‡ä»¶ï¼ˆâš ï¸ ä¼šæ¸…ç†æ‰€æœ‰æœªä½¿ç”¨çš„Dockerèµ„æºï¼‰"
	@echo "  clean-safe    - å®‰å…¨æ¸…ç†ï¼ˆåªæ¸…ç†å½“å‰é¡¹ç›®ï¼‰"
	@echo "  validate-config - éªŒè¯é…ç½®æ–‡ä»¶"
	@echo "  swagger       - ç”ŸæˆSwaggeræ–‡æ¡£"
	@echo "  jenkins-build - Jenkinsè‡ªåŠ¨åŒ–æ„å»º"
	@echo "  deploy        - éƒ¨ç½²æœåŠ¡"
	@echo "  health-check  - å¥åº·æ£€æŸ¥"

# ç”ŸæˆSwaggeræ–‡æ¡£
swagger:
	@echo "ğŸ“š ç”ŸæˆSwaggeræ–‡æ¡£..."
	swag init -g cmd/server/main.go -o docs

# æ„å»ºå¼€å‘ç¯å¢ƒé•œåƒ
build-dev: swagger
	@echo "ğŸ”¨ æ„å»ºå¼€å‘ç¯å¢ƒé•œåƒ..."
	docker-compose build backend

# æ„å»ºç”Ÿäº§ç¯å¢ƒé•œåƒ
build-prod:
	@echo "ğŸ”¨ æ„å»ºç”Ÿäº§ç¯å¢ƒé•œåƒ..."
	docker build -f Dockerfile.prod -t autocodeweb-backend:prod .

# å¯åŠ¨å¼€å‘ç¯å¢ƒ
run-dev:
	@echo "ğŸš€ å¯åŠ¨å¼€å‘ç¯å¢ƒ..."
	docker-compose up -d

# å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ
run-prod:
	@echo "ğŸš€ å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ..."
	docker-compose -f docker-compose.prod.yml up -d

# åœæ­¢å¼€å‘ç¯å¢ƒ
stop-dev:
	@echo "ğŸ›‘ åœæ­¢å¼€å‘ç¯å¢ƒ..."
	docker-compose down

# åœæ­¢ç”Ÿäº§ç¯å¢ƒ
stop-prod:
	@echo "ğŸ›‘ åœæ­¢ç”Ÿäº§ç¯å¢ƒ..."
	docker-compose -f docker-compose.prod.yml down

# æŸ¥çœ‹æ—¥å¿—
logs-dev:
	docker-compose logs -f backend

logs-prod:
	docker-compose -f docker-compose.prod.yml logs -f backend

# éªŒè¯é…ç½®
validate-config:
	@echo "ğŸ” éªŒè¯å¼€å‘ç¯å¢ƒé…ç½®..."
	APP_ENVIRONMENT=development go run cmd/server/main.go --validate-only
	@echo "ğŸ” éªŒè¯ç”Ÿäº§ç¯å¢ƒé…ç½®..."
	APP_ENVIRONMENT=production go run cmd/server/main.go --validate-only

# æ¸…ç†
clean:
	@echo "ğŸ§¹ æ¸…ç†æ„å»ºæ–‡ä»¶..."
	docker-compose down -v
	docker system prune -f
	docker image prune -f

# å®‰å…¨æ¸…ç†ï¼ˆåªæ¸…ç†å½“å‰é¡¹ç›®ï¼‰
clean-safe:
	@echo "ğŸ§¹ å®‰å…¨æ¸…ç†å½“å‰é¡¹ç›®..."
	docker-compose down -v
	@echo "âš ï¸  æ³¨æ„ï¼šåªæ¸…ç†äº†å½“å‰é¡¹ç›®çš„æ•°æ®å·å’Œå®¹å™¨"
	@echo "ğŸ’¡ å¦‚éœ€æ¸…ç†é•œåƒï¼Œè¯·æ‰‹åŠ¨æ‰§è¡Œ: docker rmi backend-backend"

# æµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	go test ./...

# æ ¼å¼åŒ–ä»£ç 
fmt:
	@echo "âœ¨ æ ¼å¼åŒ–ä»£ç ..."
	go fmt ./...

# ä»£ç æ£€æŸ¥
lint:
	@echo "ğŸ” ä»£ç æ£€æŸ¥..."
	golangci-lint run

# æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶
build-bin:
	@echo "ğŸ”¨ æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶..."
	go build -o bin/server ./cmd/server

# è¿è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶
run-bin:
	@echo "ğŸš€ è¿è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶..."
	./bin/server

# Jenkinsè‡ªåŠ¨åŒ–æ„å»º
jenkins-build:
	@echo "ğŸ”§ Jenkinsè‡ªåŠ¨åŒ–æ„å»º..."
	@echo "ç”¨æ³•: make jenkins-build ENV=dev TAG=v1.0.0 PUSH=true"
	@if [ "$(ENV)" = "" ]; then \
		echo "é”™è¯¯: è¯·æŒ‡å®šç¯å¢ƒ (ENV=dev æˆ– ENV=prod)"; \
		exit 1; \
	fi
	@chmod +x scripts/jenkins-build.sh
	@./scripts/jenkins-build.sh -e $(ENV) -t $(TAG) $(if $(PUSH),-p,)

# éƒ¨ç½²æœåŠ¡
deploy:
	@echo "ğŸš€ éƒ¨ç½²æœåŠ¡..."
	@echo "ç”¨æ³•: make deploy ENV=dev TAG=latest FORCE=false"
	@if [ "$(ENV)" = "" ]; then \
		echo "é”™è¯¯: è¯·æŒ‡å®šç¯å¢ƒ (ENV=dev æˆ– ENV=prod)"; \
		exit 1; \
	fi
	@chmod +x scripts/deploy.sh
	@./scripts/deploy.sh -e $(ENV) -t $(TAG) $(if $(FORCE),-f,)

# å¥åº·æ£€æŸ¥
health-check:
	@echo "ğŸ¥ æ‰§è¡Œå¥åº·æ£€æŸ¥..."
	@if [ "$(ENV)" = "prod" ]; then \
		docker-compose -f docker-compose.prod.yml ps; \
	else \
		docker-compose ps; \
	fi
	@echo "å¥åº·æ£€æŸ¥ç«¯ç‚¹:"
	@if [ "$(ENV)" = "prod" ]; then \
		echo "  - http://localhost:8080/api/v1/health"; \
		echo "  - http://localhost:8080/api/v1/cache/health"; \
	else \
		echo "  - http://localhost:8098/api/v1/health"; \
		echo "  - http://localhost:8098/api/v1/cache/health"; \
	fi
