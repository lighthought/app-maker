<template>
  <div class="conversation-container">
    <!-- WebSocket Áä∂ÊÄÅÊåáÁ§∫Âô® -->
    <div v-if="wsError || wsStatus === 'reconnecting'" class="ws-status-bar">
      <NAlert 
        v-if="wsError" 
        type="error" 
        :title="`${t('common.websocketError')}: ${wsError}`"
        closable
        @close="wsError = null"
      >
        <div style="margin-top: 8px;">
          <n-button size="small" @click="wsReconnect">{{ t('common.reconnect') }}</n-button>
        </div>
      </NAlert>
      <NAlert 
        v-else-if="wsStatus === 'reconnecting'" 
        type="warning" 
        :title="t('common.reconnecting', { attempts: wsReconnectAttempts, max: 5 })"
      />
    </div>

    <!-- ÂºÄÂèëÈò∂ÊÆµËøõÂ∫¶ - Ê®™ÂêëÂ±ïÁ§∫ -->
    <div class="progress-section">
      <DevStages 
        :stages="devStages" 
        layout="horizontal"
        @retry-success="handleRetrySuccess"
      />
    </div>
    
    <!-- ÂØπËØùÊ∂àÊÅØÂàóË°® -->
    <div class="conversation-messages" ref="messagesContainer">
      <ConversationMessage
        v-for="message in messages"
        :key="message.id"
        :message="message"
        @toggle-expanded="toggleMessageExpanded"
      />
      
      <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
      <div v-if="isLoading" class="loading-message">
        <div class="loading-avatar">
          <n-icon size="20" color="white">
            <LoadingIcon />
          </n-icon>
        </div>
        <div class="loading-content">
          <div class="loading-text">{{ t('common.aiThinking') }}</div>
          <div class="loading-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Â∫ïÈÉ®ËæìÂÖ•Ê°Ü -->
    <div class="input-section">
      <SmartInput
        v-model="inputValue"
        :placeholder="t('common.inputRequirements')"
        @send="handleSendMessage"
      />
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, watch, nextTick, h, onMounted, onUnmounted } from 'vue'
import { useI18n } from 'vue-i18n'
import { NIcon, NAlert, NButton } from 'naive-ui'
import ConversationMessage from './ConversationMessage.vue'
import DevStages from './DevStages.vue'
import SmartInput from './common/SmartInput.vue'
import { useProjectStore } from '@/stores/project'
import { useWebSocket } from '@/utils/websocket'
import type { ConversationMessage as ConversationMessageType, DevStage, ProjectInfoUpdate } from '@/types/project'

interface Props {
  projectGuid: string
  requirements: string
  project?: any // Êé•Êî∂È°πÁõÆ‰ø°ÊÅØ
}

const props = defineProps<Props>()
const { t } = useI18n()

// ÂÆö‰πâ‰∫ã‰ª∂
const emit = defineEmits<{
  projectInfoUpdate: [info: ProjectInfoUpdate]
  projectEnvSetup: []
}>()
const projectStore = useProjectStore()

// WebSocket ÈõÜÊàê
const {
  status: wsStatus,
  isConnected: wsConnected,
  error: wsError,
  reconnectAttempts: wsReconnectAttempts,
  projectStages: wsProjectStages,
  projectMessages: wsProjectMessages,
  projectInfo: wsProjectInfo,
  connect: wsConnect,
  disconnect: wsDisconnect,
  reconnect: wsReconnect,
  sendUserFeedback: wsSendUserFeedback
} = useWebSocket(props.projectGuid)

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const messages = ref<ConversationMessageType[]>([])
const devStages = ref<DevStage[]>([])
const isLoading = ref(false)
const messagesContainer = ref<HTMLElement>()
const inputValue = ref('')

// ÂÆöÊó∂Âà∑Êñ∞Ôºà‰Ωú‰∏∫ WebSocket ÁöÑÂ§áÁî®ÊñπÊ°àÔºâ
let refreshTimer: number | null = null

// Ê∏ÖÁêÜ WebSocket ÁºìÂ≠òÊï∞ÊçÆ
const clearWebSocketCache = () => {
  console.log('üßπ [WebSocket] Ê∏ÖÁêÜ WebSocket ÁºìÂ≠òÊï∞ÊçÆ...')
  // Ê≥®ÊÑèÔºöËøôÈáå‰∏çËÉΩÁõ¥Êé•Ê∏ÖÁ©∫ wsProjectStages Âíå wsProjectMessagesÔºåÂõ†‰∏∫ÂÆÉ‰ª¨ÊòØÊù•Ëá™ useWebSocket ÁöÑÂìçÂ∫îÂºèÊï∞ÊçÆ
  // Êàë‰ª¨Âè™ËÉΩÊ∏ÖÁêÜÊú¨Âú∞ÁöÑÂêàÂπ∂Êï∞ÊçÆÔºåËÆ©Á≥ªÁªüÈáçÊñ∞‰ªéÊé•Âè£Ëé∑Âèñ
  console.log('üßπ [WebSocket] ÁºìÂ≠òÊ∏ÖÁêÜÂÆåÊàê')
}

// Âä†ËΩΩÂºÄÂèëÈò∂ÊÆµ
const loadDevStages = async () => {
  try {
    console.log('üîÑ [DevStages] ÂºÄÂßã‰ªéÊé•Âè£Ëé∑ÂèñÂºÄÂèëÈò∂ÊÆµÊï∞ÊçÆ...')
    const stages = await projectStore.getProjectStages(props.projectGuid)
    if (stages) {
      console.log('‚úÖ [DevStages] Êé•Âè£Ëé∑ÂèñÊàêÂäüÔºåÊï∞ÊçÆÈáè:', stages.length, 'Êï∞ÊçÆ:', stages)
      devStages.value = stages
    } else {
      console.log('‚ö†Ô∏è [DevStages] Êé•Âè£ËøîÂõûÁ©∫Êï∞ÊçÆ')
    }
  } catch (error) {
    console.error('‚ùå [DevStages] Êé•Âè£Ëé∑ÂèñÂ§±Ë¥•:', error)
  }
}

// Âä†ËΩΩÂØπËØùÂéÜÂè≤
const loadConversations = async () => {
  try {
    console.log('üîÑ [Messages] ÂºÄÂßã‰ªéÊé•Âè£Ëé∑ÂèñÂØπËØùÂéÜÂè≤Êï∞ÊçÆ...')
    const conversations = await projectStore.getProjectMessages(props.projectGuid)
    if (conversations) {
      console.log('‚úÖ [Messages] Êé•Âè£Ëé∑ÂèñÊàêÂäüÔºåÊï∞ÊçÆÈáè:', conversations.data?.length || 0, 'Êï∞ÊçÆ:', conversations.data)
      messages.value = conversations.data
      scrollToBottom()
    } else {
      console.log('‚ö†Ô∏è [Messages] Êé•Âè£ËøîÂõûÁ©∫Êï∞ÊçÆ')
    }
  } catch (error) {
    console.error('‚ùå [Messages] Êé•Âè£Ëé∑ÂèñÂ§±Ë¥•:', error)
  }
}

// ÂêåÊ≠• WebSocket Êï∞ÊçÆÂà∞Êú¨Âú∞Áä∂ÊÄÅ - Â¢ûÈáèËøΩÂä†
const syncWebSocketData = () => {
  console.log('üîÑ [WebSocket] ÂºÄÂßãÂêåÊ≠• WebSocket Êï∞ÊçÆ...')
  
  // Â¢ûÈáèÂêåÊ≠•È°πÁõÆÈò∂ÊÆµÊï∞ÊçÆ
  if (wsProjectStages.value.length > 0) {
    console.log('üìä [DevStages] WebSocket Êï∞ÊçÆ:', wsProjectStages.value.length, 'Êù°')
    console.log('üìä [DevStages] ÂΩìÂâçÊú¨Âú∞Êï∞ÊçÆ:', devStages.value.length, 'Êù°')
    
    // Ëé∑ÂèñÂΩìÂâçÊú¨Âú∞Â∑≤ÊúâÁöÑÈò∂ÊÆµID
    const existingStageIds = new Set(devStages.value.map(stage => stage.id))
    
    // ÊâæÂá∫ÈúÄË¶ÅËøΩÂä†ÁöÑÊñ∞Èò∂ÊÆµ
    const newStages = wsProjectStages.value.filter(stage => !existingStageIds.has(stage.id))
    
    if (newStages.length > 0) {
      console.log('‚ûï [DevStages] ÂèëÁé∞Êñ∞Èò∂ÊÆµ:', newStages.length, 'Êù°ÔºåËøΩÂä†Âà∞Êú¨Âú∞Êï∞ÊçÆ')
      devStages.value.push(...newStages)
      // ÊåâIDÊéíÂ∫è‰øùÊåÅÈ°∫Â∫è
      devStages.value.sort((a, b) => a.id.localeCompare(b.id))
    } else {
      console.log('‚ÑπÔ∏è [DevStages] Ê≤°ÊúâÊñ∞Èò∂ÊÆµÈúÄË¶ÅËøΩÂä†')
    }
    
    console.log('‚úÖ [DevStages] ÂêåÊ≠•ÂÆåÊàêÔºåÊúÄÁªàÊï∞ÊçÆÈáè:', devStages.value.length, 'Êù°')
  }
  
  // Â¢ûÈáèÂêåÊ≠•È°πÁõÆÊ∂àÊÅØÊï∞ÊçÆ
  if (wsProjectMessages.value.length > 0) {
    console.log('üí¨ [Messages] WebSocket Êï∞ÊçÆ:', wsProjectMessages.value.length, 'Êù°')
    console.log('üí¨ [Messages] ÂΩìÂâçÊú¨Âú∞Êï∞ÊçÆ:', messages.value.length, 'Êù°')
    
    // Ëé∑ÂèñÂΩìÂâçÊú¨Âú∞Â∑≤ÊúâÁöÑÊ∂àÊÅØID
    const existingMessageIds = new Set(messages.value.map(msg => msg.id))
    
    // ÊâæÂá∫ÈúÄË¶ÅËøΩÂä†ÁöÑÊñ∞Ê∂àÊÅØ
    const newMessages = wsProjectMessages.value.filter(msg => !existingMessageIds.has(msg.id))
    
    if (newMessages.length > 0) {
      console.log('‚ûï [Messages] ÂèëÁé∞Êñ∞Ê∂àÊÅØ:', newMessages.length, 'Êù°ÔºåËøΩÂä†Âà∞Êú¨Âú∞Êï∞ÊçÆ')
      messages.value.push(...newMessages)
      // ÊåâÊó∂Èó¥ÊéíÂ∫è
      messages.value.sort((a, b) => new Date(a.created_at).getTime() - new Date(b.created_at).getTime())
      scrollToBottom()
    } else {
      console.log('‚ÑπÔ∏è [Messages] Ê≤°ÊúâÊñ∞Ê∂àÊÅØÈúÄË¶ÅËøΩÂä†')
    }
    
    console.log('‚úÖ [Messages] ÂêåÊ≠•ÂÆåÊàêÔºåÊúÄÁªàÊï∞ÊçÆÈáè:', messages.value.length, 'Êù°')
  }
}

// Êô∫ËÉΩÂêàÂπ∂ÂØπËØùÂéÜÂè≤Ôºà‰øùÊåÅÁî®Êà∑Êìç‰ΩúÁä∂ÊÄÅÔºâ
const mergeConversations = async () => {
  try {
    console.log('üîÑ [Merge] ÂºÄÂßãÊô∫ËÉΩÂêàÂπ∂ÂØπËØùÂéÜÂè≤...')
    const conversations = await projectStore.getProjectMessages(props.projectGuid)
    if (!conversations || !conversations.data) {
      console.log('‚ö†Ô∏è [Merge] Êé•Âè£ËøîÂõûÁ©∫Êï∞ÊçÆÔºåË∑≥ËøáÂêàÂπ∂')
      return
    }
    
    const newMessages = conversations.data
    const currentMessages = messages.value
    
    console.log('üìä [Merge] ÂêàÂπ∂ÂâçÁä∂ÊÄÅ:')
    console.log('  - Êé•Âè£Êï∞ÊçÆ:', newMessages.length, 'Êù°')
    console.log('  - Êú¨Âú∞Êï∞ÊçÆ:', currentMessages.length, 'Êù°')
    
    // Â¶ÇÊûúÊ∂àÊÅØÊï∞ÈáèÁõ∏ÂêåÔºåÊ£ÄÊü•ÊòØÂê¶ÊúâÂÜÖÂÆπÊõ¥Êñ∞
    if (newMessages.length === currentMessages.length) {
      console.log('üîç [Merge] Ê∂àÊÅØÊï∞ÈáèÁõ∏ÂêåÔºåÊ£ÄÊü•ÂÜÖÂÆπÊõ¥Êñ∞...')
      let hasUpdates = false
      const updatedMessages = newMessages.map((newMsg, index) => {
        const currentMsg = currentMessages[index]
        
        // Ê£ÄÊü•Ê∂àÊÅØÂÜÖÂÆπÊòØÂê¶ÊúâÊõ¥Êñ∞
        if (currentMsg && (
          currentMsg.content !== newMsg.content ||
          currentMsg.markdown_content !== newMsg.markdown_content ||
          currentMsg.updated_at !== newMsg.updated_at
        )) {
          hasUpdates = true
          console.log('üîÑ [Merge] ÂèëÁé∞Ê∂àÊÅØÊõ¥Êñ∞:', newMsg.id)
          // ‰øùÊåÅÁî®Êà∑ÁöÑÂ±ïÂºÄ/ÊäòÂè†Áä∂ÊÄÅ
          return {
            ...newMsg,
            is_expanded: currentMsg.is_expanded
          }
        }
        
        // Ê≤°ÊúâÊõ¥Êñ∞Ôºå‰øùÊåÅÂéüÊ∂àÊÅØÔºàÂåÖÊã¨Áî®Êà∑Áä∂ÊÄÅÔºâ
        return currentMsg || newMsg
      })
      
      if (hasUpdates) {
        console.log('‚úÖ [Merge] ÂÜÖÂÆπÊõ¥Êñ∞ÂÆåÊàê')
        messages.value = updatedMessages
      } else {
        console.log('‚ÑπÔ∏è [Merge] Ê≤°ÊúâÂÜÖÂÆπÊõ¥Êñ∞')
      }
      return
    }
    
    // Ê∂àÊÅØÊï∞Èáè‰∏çÂêåÔºåËøõË°åÂÆåÊï¥ÂêàÂπ∂
    console.log('üîÄ [Merge] Ê∂àÊÅØÊï∞Èáè‰∏çÂêåÔºåËøõË°åÂÆåÊï¥ÂêàÂπ∂...')
    const existingMessagesMap = new Map()
    currentMessages.forEach(msg => {
      existingMessagesMap.set(msg.id, {
        is_expanded: msg.is_expanded,
        // ÂèØ‰ª•‰øùÂ≠òÂÖ∂‰ªñÁî®Êà∑Êìç‰ΩúÁä∂ÊÄÅ
      })
    })
    
    // ÂêàÂπ∂Êñ∞Ê∂àÊÅØÔºå‰øùÊåÅÁî®Êà∑Áä∂ÊÄÅ
    const mergedMessages = newMessages.map(newMsg => {
      const existingState = existingMessagesMap.get(newMsg.id)
      if (existingState) {
        // ‰øùÊåÅÁî®Êà∑ÁöÑÂ±ïÂºÄ/ÊäòÂè†Áä∂ÊÄÅ
        return {
          ...newMsg,
          is_expanded: existingState.is_expanded
        }
      }
      return newMsg
    })
    
    // Ê£ÄÊü•ÊòØÂê¶ÊúâÊñ∞Ê∂àÊÅØ
    const hasNewMessages = mergedMessages.length > currentMessages.length
    const lastMessageId = currentMessages.length > 0 ? currentMessages[currentMessages.length - 1].id : null
    const newLastMessageId = mergedMessages.length > 0 ? mergedMessages[mergedMessages.length - 1].id : null
    
    console.log('üìà [Merge] ÂêàÂπ∂ÁªìÊûú:')
    console.log('  - ÊúÄÁªàÊï∞ÊçÆÈáè:', mergedMessages.length, 'Êù°')
    console.log('  - ÊòØÂê¶ÊúâÊñ∞Ê∂àÊÅØ:', hasNewMessages)
    
    // Êõ¥Êñ∞Ê∂àÊÅØÂàóË°®
    messages.value = mergedMessages
    
    // Â¶ÇÊûúÊúâÊñ∞Ê∂àÊÅØÔºåÊªöÂä®Âà∞Â∫ïÈÉ®
    if (hasNewMessages && lastMessageId !== newLastMessageId) {
      console.log('üìú [Merge] Ê£ÄÊµãÂà∞Êñ∞Ê∂àÊÅØÔºåÊªöÂä®Âà∞Â∫ïÈÉ®')
      scrollToBottom()
    }
    
    console.log('‚úÖ [Merge] Êô∫ËÉΩÂêàÂπ∂ÂÆåÊàê')
    
  } catch (error) {
    console.error('‚ùå [Merge] ÂêàÂπ∂ÂØπËØùÂéÜÂè≤Â§±Ë¥•:', error)
  }
}

// ÊªöÂä®Âà∞Â∫ïÈÉ®
const scrollToBottom = () => {
  nextTick(() => {
    if (messagesContainer.value) {
      messagesContainer.value.scrollTop = messagesContainer.value.scrollHeight
    }
  })
}

// ÂàáÊç¢Ê∂àÊÅØÂ±ïÂºÄÁä∂ÊÄÅ
const toggleMessageExpanded = (messageId: string) => {
  const message = messages.value.find(m => m.id === messageId)
  if (message) {
    message.is_expanded = !message.is_expanded
  }
}

// Â§ÑÁêÜÈáçËØïÊàêÂäü‰∫ã‰ª∂
const handleRetrySuccess = async () => {
  console.log('üîÑ [Retry] Êî∂Âà∞ÈáçËØïÊàêÂäü‰∫ã‰ª∂ÔºåÈáçÊñ∞Âä†ËΩΩÂºÄÂèëÈò∂ÊÆµÊï∞ÊçÆ...')
  await loadDevStages()
  console.log('‚úÖ [Retry] ÂºÄÂèëÈò∂ÊÆµÊï∞ÊçÆÈáçÊñ∞Âä†ËΩΩÂÆåÊàê')
}

// ÂèëÈÄÅÊ∂àÊÅØ
const handleSendMessage = async (content: string) => {
  if (!content.trim()) return
  
  isLoading.value = true
  
  try {
    // Â¶ÇÊûúÈ°πÁõÆÂ∑≤ÂÆåÊàê‰∏îÊ≤°Êúâ WebSocket ËøûÊé•ÔºåÈáçÊñ∞ÂêØÂä®ËøûÊé•
    if (isProjectCompleted() && !wsConnected.value) {
      console.log('Áî®Êà∑ÂèëÈÄÅÊñ∞Ê∂àÊÅØÔºåÈáçÊñ∞ÂêØÂä® WebSocket ËøûÊé•')
      try {
        await wsConnect()
      } catch (error) {
        console.error('ÈáçÊñ∞ÂêØÂä® WebSocket ËøûÊé•Â§±Ë¥•:', error)
      }
    }
    
    // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
    const userMessage = await projectStore.addChatMessage(props.projectGuid, {
      type: 'user',
      content: content.trim(),
      is_expanded: false
    })
    
    if (userMessage) {
      messages.value.push(userMessage)
      scrollToBottom()
    }
    
    // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
    inputValue.value = ''
    
    // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÂèëÈÄÅÂà∞ÂêéÁ´ØÁöÑÈÄªËæë
    // ÂêéÁ´Ø‰ºöÈÄöËøáWebSocketÊé®ÈÄÅAIÂõûÂ§ç
    
  } catch (error) {
    console.error('ÂèëÈÄÅÊ∂àÊÅØÂ§±Ë¥•:', error)
  } finally {
    isLoading.value = false
  }
}

// ÂÆöÊó∂Âà∑Êñ∞Êï∞ÊçÆÔºà‰Ωú‰∏∫ WebSocket ÁöÑÂ§áÁî®ÊñπÊ°àÔºâ
const startAutoRefresh = () => {
  // Âè™ÊúâÂú® WebSocket Êú™ËøûÊé•Êó∂ÊâçÂêØÂä®ÂÆöÊó∂Âà∑Êñ∞
  if (!wsConnected.value) {
    refreshTimer = window.setInterval(async () => {
      await mergeConversations() // ‰ΩøÁî®Êô∫ËÉΩÂêàÂπ∂ËÄå‰∏çÊòØÂÆåÂÖ®ÊõøÊç¢
      await loadDevStages()
    }, 5000) // ÊØè5ÁßíÂà∑Êñ∞‰∏ÄÊ¨°
  }
}

const stopAutoRefresh = () => {
  if (refreshTimer) {
    window.clearInterval(refreshTimer)
    refreshTimer = null
  }
}

// ÁõëÂê¨ WebSocket ËøûÊé•Áä∂ÊÄÅ
watch(wsConnected, (connected) => {
  if (connected) {
    console.log('üîó [WebSocket] ËøûÊé•ÊàêÂäüÔºåÂÅúÊ≠¢ÂÆöÊó∂Âà∑Êñ∞ÔºåÂºÄÂßãÂêåÊ≠•Êï∞ÊçÆ')
    // WebSocket ËøûÊé•ÊàêÂäüÔºåÂÅúÊ≠¢ÂÆöÊó∂Âà∑Êñ∞
    stopAutoRefresh()
    // ÂêåÊ≠• WebSocket Êï∞ÊçÆ
    syncWebSocketData()
  } else {
    console.log('üîå [WebSocket] ËøûÊé•Êñ≠ÂºÄÔºåÊ∏ÖÁêÜÁºìÂ≠òÂπ∂ÂêØÂä®ÂÆöÊó∂Âà∑Êñ∞')
    // WebSocket Êñ≠ÂºÄÔºåÊ∏ÖÁêÜÁºìÂ≠òÊï∞ÊçÆ
    clearWebSocketCache()
    // ÈáçÊñ∞‰ªéÊé•Âè£Ëé∑ÂèñÊúÄÊñ∞Êï∞ÊçÆ
    loadDevStages()
    loadConversations()
    // ÂêØÂä®ÂÆöÊó∂Âà∑Êñ∞‰Ωú‰∏∫Â§áÁî®
    startAutoRefresh()
  }
})

// ÁõëÂê¨ WebSocket Êï∞ÊçÆÂèòÂåñ
watch([wsProjectStages, wsProjectMessages], (newValues, oldValues) => {
  if (wsConnected.value) {
    const [newStages, newMessages] = newValues
    const [oldStages, oldMessages] = oldValues || [[], []]
    
    console.log('üì° [WebSocket] Êï∞ÊçÆÂèòÂåñÊ£ÄÊµã:')
    console.log('  - DevStages: ÊóßÊï∞ÊçÆ', oldStages?.length || 0, 'Êù° ‚Üí Êñ∞Êï∞ÊçÆ', newStages?.length || 0, 'Êù°')
    console.log('  - Messages: ÊóßÊï∞ÊçÆ', oldMessages?.length || 0, 'Êù° ‚Üí Êñ∞Êï∞ÊçÆ', newMessages?.length || 0, 'Êù°')
    
    syncWebSocketData()
  }
}, { deep: true })

// ÁõëÂê¨È°πÁõÆ‰ø°ÊÅØÊõ¥Êñ∞
watch(wsProjectInfo, (newInfo) => {
  if (newInfo && Object.keys(newInfo).length > 0) {
    emit('projectInfoUpdate', {
      id: newInfo.id,
      guid: newInfo.guid,
      name: newInfo.name,
      status: newInfo.status,
      description: newInfo.description,
      previewUrl: newInfo.previewUrl,
    })
  }
}, { deep: true })

// ÁõëÂê¨ setup_environment Èò∂ÊÆµÁä∂ÊÄÅÂèòÂåñ
const previousSetupStatus = ref<string | null>(null)
watch(wsProjectStages, (newStages) => {
  if (newStages && newStages.length > 0) {
    const setupStage = newStages.find(stage => stage.name === 'setup_environment')
    if (setupStage) {
      const currentStatus = setupStage.status
      // Âè™ÊúâÂΩìÁä∂ÊÄÅ‰ªé in_progress Âèò‰∏∫ done Êó∂ÊâçËß¶Âèë
      if (previousSetupStatus.value === 'in_progress' && currentStatus === 'done') {
        console.log('setup_environment Èò∂ÊÆµÂ∑≤ÂÆåÊàêÔºåÈÄöÁü•Âà∑Êñ∞Êñá‰ª∂Ê†ë')
        emit('projectEnvSetup')
      }
      previousSetupStatus.value = currentStatus
    }
  }
}, { deep: true })


// ÂõæÊ†áÁªÑ‰ª∂
const LoadingIcon = () => h('svg', { 
  viewBox: '0 0 24 24', 
  fill: 'currentColor',
  style: 'width: 1em; height: 1em;'
}, [
  h('path', { d: 'M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10A10 10 0 0 0 12 2zm0 18a8 8 0 0 1-8-8 8 8 0 0 1 8-8 8 8 0 0 1 8 8 8 8 0 0 1-8 8z' }),
  h('path', { 
    d: 'M12 4a8 8 0 0 1 8 8 8 8 0 0 1-8 8',
    style: 'opacity: 0.3;'
  })
])

// Ê£ÄÊü•È°πÁõÆÊòØÂê¶Â∑≤ÂÆåÊàê
const isProjectCompleted = () => {
  // Áªü‰∏Ä‰ΩøÁî® project.value?.status Êù•Âà§Êñ≠È°πÁõÆÊòØÂê¶ÂÆåÊàêÊàñÂ§±Ë¥•
  return props.project?.status === 'done' || props.project?.status === 'failed'
}


// ÂàùÂßãÂåñ
const initialize = async () => {
  console.log('üöÄ [Init] ÂºÄÂßãÂàùÂßãÂåñ ConversationContainer...')
  
  // 1. ÂÖàÂä†ËΩΩÂàùÂßãÊï∞ÊçÆÔºàÊé•Âè£Ëé∑ÂèñÔºâ
  console.log('üì° [Init] Ê≠•È™§1: ‰ªéÊé•Âè£Ëé∑ÂèñÂàùÂßãÊï∞ÊçÆ...')
  await loadDevStages()
  await loadConversations()
  console.log('‚úÖ [Init] Ê≠•È™§1ÂÆåÊàê: Êé•Âè£Êï∞ÊçÆÂ∑≤Â±ïÁ§∫')
  
  // Ê£ÄÊü•È°πÁõÆÊòØÂê¶Â∑≤ÂÆåÊàê
  if (isProjectCompleted()) {
    console.log('‚ÑπÔ∏è [Init] È°πÁõÆÂ∑≤ÂÆåÊàêÔºå‰∏çÂêØÂä® WebSocket ËøûÊé•ÂíåÂÆöÊó∂Âà∑Êñ∞')
    return
  }
  
  // 2. Êé•Âè£Êï∞ÊçÆÂ±ïÁ§∫ÂêéÔºåÂêØÂä® WebSocket ËøûÊé•
  console.log('üîó [Init] Ê≠•È™§2: ÂêØÂä® WebSocket ËøûÊé•...')
  try {
    await wsConnect()
    console.log('‚úÖ [Init] Ê≠•È™§2ÂÆåÊàê: WebSocket ËøûÊé•ÊàêÂäü')
  } catch (error) {
    console.error('‚ùå [Init] WebSocket ËøûÊé•Â§±Ë¥•ÔºåÂ∞Ü‰ΩøÁî®ÂÆöÊó∂Âà∑Êñ∞:', error)
    // WebSocket ËøûÊé•Â§±Ë¥•ÔºåÂêØÂä®ÂÆöÊó∂Âà∑Êñ∞‰Ωú‰∏∫Â§áÁî®
    startAutoRefresh()
  }
  
  console.log('üéâ [Init] ÂàùÂßãÂåñÂÆåÊàê')
}

// ÁîüÂëΩÂë®ÊúüÈí©Â≠ê
onMounted(() => {
  initialize()
})

onUnmounted(() => {
  stopAutoRefresh()
  wsDisconnect()
})
</script>

<style scoped>
.conversation-container {
  height: 100%;
  display: flex;
  flex-direction: column;
  background: #f8fafc;
}

.ws-status-bar {
  flex-shrink: 0;
  padding: var(--spacing-sm) var(--spacing-lg);
  background: white;
  border-bottom: 1px solid #e2e8f0;
}

.progress-section {
  flex-shrink: 0;
  padding: var(--spacing-sm) var(--spacing-lg);
  background: white;
  border-bottom: 1px solid #e2e8f0;
}

.conversation-messages {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: var(--spacing-lg);
  background: #f8fafc;
  width: 100%;
  box-sizing: border-box;
}

.input-section {
  flex-shrink: 0;
  padding: var(--spacing-md) var(--spacing-lg);
  background: white;
  border-top: 1px solid #e2e8f0;
}

/* Âä†ËΩΩÁä∂ÊÄÅÊ†∑Âºè */
.loading-message {
  display: flex;
  align-items: flex-start;
  gap: var(--spacing-sm);
  margin-bottom: var(--spacing-lg);
}

.loading-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #D69E2E;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  animation: pulse 2s infinite;
}

.loading-content {
  background: white;
  border: 1px solid var(--border-color);
  padding: var(--spacing-md) var(--spacing-lg);
  border-radius: var(--border-radius-lg);
  border-bottom-left-radius: var(--border-radius-sm);
}

.loading-text {
  font-size: 0.9rem;
  color: var(--text-secondary);
  margin-bottom: var(--spacing-xs);
}

.loading-dots {
  display: flex;
  gap: 4px;
}

.loading-dots span {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: #D69E2E;
  animation: bounce 1.4s infinite ease-in-out both;
}

.loading-dots span:nth-child(1) {
  animation-delay: -0.32s;
}

.loading-dots span:nth-child(2) {
  animation-delay: -0.16s;
}

@keyframes pulse {
  0% {
    box-shadow: 0 0 0 0 rgba(214, 158, 46, 0.7);
  }
  70% {
    box-shadow: 0 0 0 10px rgba(214, 158, 46, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(214, 158, 46, 0);
  }
}

@keyframes bounce {
  0%, 80%, 100% {
    transform: scale(0);
  }
  40% {
    transform: scale(1);
  }
}

/* ÊªöÂä®Êù°Ê†∑Âºè - ‰∏éÂºÄÂèëËøõÂ∫¶Âå∫Âüü‰øùÊåÅ‰∏ÄËá¥ */
.conversation-messages::-webkit-scrollbar {
  width: 6px;
}

.conversation-messages::-webkit-scrollbar-track {
  background: transparent;
}

.conversation-messages::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 2px;
}

.conversation-messages::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}
</style>
